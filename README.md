
## **🔍 Smart Contract Analysis Scripts**

This repository contains **Python scripts** that extract key **complexity and risk metrics** from Solidity and Vyper smart contracts using [Slither](https://github.com/crytic/slither). The scripts are designed to operate within a **parent directory** that contains all the contracts retrieved using `rebuild_project.py`.

Each contract directory should be structured so that it can be analyzed with `run-slither.sh`, which generates a `function-summary.txt` and `inheritance.json` file in each subdirectory. The later scripts, particularly `unique_stats.py`, aggregate and analyze these files.

### **📌 Overview**
These scripts analyze **Ethereum smart contracts** to compute:
1. **Cyclomatic Complexity (TCC)** and **External Calls (TEC)** from the `function-summary` printer.
2. **Maximum Inheritance Depth (ID)** from the `inheritance` printer.
3. **Total Decision Points (TDP)** by scanning Solidity or Vyper source code.
4. **Average Total Value Locked (TVL)** for DeFi protocols.

---

## **📝 Scripts**
| Script | Description |
|--------|------------|
| `rebuild_project.py` | Fetches and reconstructs verified contracts from Arbiscan/Etherscan into structured directories. |
| `run-slither.sh` | **Autogenerated** once the contract is rebuilt. Runs Slither within each contract directory to generate `function-summary.txt` and `inheritance.json`. |
| `stats.py` | Parses the `function-summary.txt` file to compute **TEC (Total External Calls)** and **TCC (Cyclomatic Complexity)** per contract. |
| `unique_stats.py` | Merges multiple `function-summary.txt` outputs into a single dataset and computes **aggregate TEC and TCC**. Uses `hashes.json` to deduplicate library counts. |
| `inheritance.py` | Analyzes `inheritance.json` to compute the **maximum inheritance depth**. |
| `tdp.py` | Scans Solidity source code to count **Total Decision Points (TDP)** (e.g., `if`, `require()`, `for`, `while`). |
| `avg_tvls.py` | Fetches and calculates the **average TVL (Total Value Locked)** for DeFi protocols over a given time period using DeFiLlama's API. |

**🚨 Note:** `analyze_contract.py` is **deprecated** and no longer used in favor of `unique_stats.py`.

---

## **📖 Setup Guide**

### **1️⃣ Install Dependencies**
To set up a **Python virtual environment (`venv`)**:
```sh
# Create a virtual environment
python3 -m venv venv

# Activate venv (Linux/macOS)
source venv/bin/activate
```

Now, install **Slither**, Solidity compiler (`solc`), and required dependencies inside the virtual environment:
```sh
pip install slither-analyzer jq requests
```

### **2️⃣ Install & Select `solc` Version**
To ensure compatibility with different Solidity versions, install `solc-select`:
```sh
pip install solc-select
solc-select install 0.8.20  # Install the required version
solc-select use 0.8.20      # Use the selected version
```

To verify the installed version:
```sh
solc --version
```

---

## **🚀 Running the Analysis**

### **🔹 Step 1: Rebuilding Contract Projects**
Use `rebuild_project.py` to fetch and reconstruct verified contracts from Arbiscan or Etherscan.
```sh
python rebuild_project.py 0xCONTRACT_ADDRESS
```
This will create a **subdirectory for the contract**, containing all necessary Solidity files and an autogenerated `run-slither.sh` script.

### **🔹 Step 2: Running Slither**
Navigate to the contract directory and run:
```sh
bash run-slither.sh
```
This will generate:
- `function-summary.txt` (contains TEC and TCC data)
- `inheritance.json` (contains inheritance hierarchy data)

### **🔹 Step 3: Computing Hashes**
Before running `unique_stats.py`, you must generate `hashes.json` to allow deduplication of library counts.
```sh
python hash_mapper.py $(find 0x* -name "*.sol") > hashes.json
```

### **🔹 Step 4: Aggregating Data**
Once all contracts have been analyzed, use `unique_stats.py` to aggregate the results:
```sh
python unique_stats.py hashes.json $(find . -name function-summary.txt) > merged_stats.json
```
This script will merge all function summaries and compute:
- **Total External Calls (TEC)**
- **Total Cyclomatic Complexity (TCC)**

🚨 **Note:** You no longer need to use `jq` to extract TEC/TCC, as `merged_stats.json` now includes them directly.

### **🔹 Step 5: Inheritance & Decision Points Analysis**
To analyze inheritance depth:
```sh
python3 inheritance.py $(find . -name "inheritance.json") > inheritance.json
```
To analyze Total Decision Points (TDP):
```sh
python3 tdp.py $(find . -name "*.sol") $(find . -name "*.vy") > tdp.json
```

---

## **🚧 Known Issues**
- **Possible TEC Undercounting:** There may be an issue where the total number of **external calls (TEC) is undercounted** when the Slither output table is broken across multiple lines. This issue is being investigated, and workarounds may be required to parse multi-line external call entries correctly.

- **Manual Copying of Configuration Files:** To get contracts to compile in some cases, it was necessary to manually copy over `slither.config.json`, `foundry.toml`, and `remappings.txt` files from the source repositories at the correct commits.

- **Deduplication Limitations:** The deduplication detection in `unique_stats.py` **only works when duplicate code is in the same file**, with comments and newlines removed. **It will not detect duplicates across different file structures (e.g., flat files or substantial code modifications).**

---

## **🎯 Summary**
| Metric | Script | Slither Printer |
|--------|--------|----------------|
| **Cyclomatic Complexity (TCC)** | `function-summary.py` | `function-summary` |
| **Total External Calls (TEC)** | `function-summary.py` | `function-summary` |
| **Inheritance Depth (ID)** | `inheritance.py` | `inheritance` |
| **Total Decision Points (TDP) - Solidity** | `tdp.py` | _(Custom Solidity parsing)_ |
| **Average TVL (DeFi Protocols)** | `avg_tvls.py` | _(DeFiLlama API)_ |

🚀 **Use these scripts to quickly assess smart contract complexity risks!** 🚀

